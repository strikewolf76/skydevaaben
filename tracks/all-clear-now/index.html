<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>All Clear Now</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex, nofollow">

  <meta property="og:type" content="music.song">
  <meta property="og:site_name" content="Skydevaaben">
  <meta property="og:title" content="All Clear Now">
  <meta property="og:description" content="Tap to open in Spotify.">
  <meta property="og:url" content="https://skydevaaben.no/tracks/all-clear-now/index.html">
  <meta property="og:image" content="https://skydevaaben.no/assets/og/all-clear-now-cover.jpg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="All Clear Now">
  <meta name="twitter:description" content="Tap to open in Spotify.">
  <meta name="twitter:image" content="https://skydevaaben.no/assets/og/all-clear-now-cover.jpg">

  <style>
    body {
      background: url('https://skydevaaben.no/assets/og/all-clear-now-cover-bg.jpg') no-repeat center center;
      background-size: cover;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      text-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    .content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .cover {
      width: min(300px, 80vw);
      height: min(300px, 80vw);
      object-fit: cover;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      margin-bottom: 20px;
    }
    .cta {
      background: rgba(0,0,0,0.7);
      color: white;
      border: 2px solid white;
      text-decoration: none;
      padding: 14px 22px;
      font-size: 18px;
      border-radius: 10px;
      transition: background 0.3s ease;
    }
    .cta:hover {
      background: rgba(0,0,0,0.9);
    }
    .consent-info {
      font-size: 13px;
      opacity: 0.9;
      margin-top: 20px;
      max-width: 480px;
      line-height: 1.4;
      text-align: center;
    }
  </style>
</head>

<body>

  <div class="content">
    <img src="https://skydevaaben.no/assets/og/all-clear-now-cover-fg.jpg" alt="" class="cover">
    <a class="cta" href="#" data-dest="spotify" rel="noopener noreferrer">Listen on Spotify</a>
  </div>

  <p id="consent-info" class="consent-info" style="display:none;">
    This link uses measurement to improve campaigns. By continuing, you agree.
  </p>

<script>
(function () {
  var DESTINATIONS = [{"key":"spotify","baseUrl":"https://open.spotify.com/track/2QFXBv958pJyqDhrr6ydVl","spotifyId":"2QFXBv958pJyqDhrr6ydVl"}];
  var META_PIXEL_ID = "802257822837167";
  var TRACK_SLUG = "all-clear-now";
  var UTM_CAMPAIGN = "all-clear-now";

  var params = new URLSearchParams(window.location.search || "");
  var CID = params.get("cid") || "";
  var consentGranted = false;
  var pixelEventsQueued = [];
  var clickLocked = false;
  var pageViewFired = false;

  // Allow known social crawlers to fetch OG tags (no redirect)
  var ua = navigator.userAgent || "";
  var isCrawler = /(facebookexternalhit|facebot|twitterbot|linkedinbot|discordbot|pinterest|slackbot|whatsapp|telegrambot|skypeuripreview)/i.test(ua);
  var isInAppBrowser = /(FBAN|FBAV|Instagram|Messenger|Line|TikTok)/i.test(ua);
  if (isCrawler) return;

  // Check existing consent
  var hasConsent = false;
  try {
    hasConsent = localStorage.getItem("sv_cookie_consent") === "granted";
  } catch (_) {}

  // Show consent info for new users
  if (!hasConsent) {
    var consentInfoEl = document.getElementById("consent-info");
    if (consentInfoEl) consentInfoEl.style.display = "block";
  }

  // Grant consent (once only)
  function grantConsent() {
    if (consentGranted) return;
    consentGranted = true;
    try {
      localStorage.setItem("sv_cookie_consent", "granted");
    } catch (_) {}
    if (window.fbq && META_PIXEL_ID) {
      fbq("consent", "grant");
      // Fire queued events
      while (pixelEventsQueued.length > 0) {
        var ev = pixelEventsQueued.shift();
        ev();
      }
    }
  }

  function firePageView() {
    if (pageViewFired) return;
    if (!window.fbq || !META_PIXEL_ID) return;
    pageViewFired = true;
    try { fbq("track", "PageView"); } catch (_) {}
  }

  // Initialize Meta Pixel (if ID present)
  if (META_PIXEL_ID) {
    !(function (f, b, e, v, n, t, s) {
      if (f.fbq) return;
      n = f.fbq = function () { n.callMethod ? n.callMethod.apply(n, arguments) : n.queue.push(arguments); };
      if (!f._fbq) f._fbq = n;
      n.push = n; n.loaded = !0; n.version = "2.0"; n.queue = [];
      t = b.createElement(e); t.async = !0; t.src = v;
      s = b.getElementsByTagName(e)[0]; s.parentNode.insertBefore(t, s);
    })(window, document, "script", "https://connect.facebook.net/en_US/fbevents.js");

    fbq("init", META_PIXEL_ID);
    
    // TEMP DEBUG: always grant consent (remove when verified)
    try { fbq("consent", "grant"); } catch (_) {}

    // If returning user: grant immediately
    if (hasConsent) {
      grantConsent();
      firePageView();
    } else {
      // Queue PageView until consent granted
      pixelEventsQueued.push(function () { firePageView(); });
    }
  }

  function appendUtms(url, utms) {
    var u = new URL(url);
    Object.keys(utms).forEach(function(k) {
      if (utms[k]) u.searchParams.set(k, utms[k]);
    });
    return u.toString();
  }

  function trackOutbound(destKey, dest) {
    if (!window.fbq || !META_PIXEL_ID) return;
    try {
      var eventId = "ob_" + Date.now() + "_" + Math.random().toString(16).slice(2);
      fbq("trackCustom", "OutboundSpotify", {
        kind: "click",
        cid: CID || "",
        slug: TRACK_SLUG || "",
        dest: destKey === "spotify" ? "spotify" : destKey,
        channel: "meta",
        track_id: (dest && dest.spotifyId) ? dest.spotifyId : ""
      }, { eventID: eventId });
    } catch (_) {}
  }

  function handleClick(destKey, e) {
    // Allow modified clicks (open in new tab etc.)
    if (e && (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey || e.button === 1)) return;

    if (clickLocked) return;

    if (e && e.preventDefault) e.preventDefault();

    var dest = DESTINATIONS.find(d => d.key === destKey);
    if (!dest) return;

    clickLocked = true;

    var webUrl = appendUtms(dest.baseUrl, { utm_campaign: UTM_CAMPAIGN, utm_content: CID });

    grantConsent();
    firePageView();
    trackOutbound(destKey, dest);

    try {
      if (navigator.sendBeacon && META_PIXEL_ID) {
        navigator.sendBeacon("https://www.facebook.com/tr/", new Blob([], { type: "application/x-www-form-urlencoded" }));
      }
    } catch (_) {}

    // 1) Try Spotify app only for Spotify destination (and only if we have an ID)
    if (destKey === "spotify" && dest.spotifyId && !isInAppBrowser) {
      setTimeout(function () {
        window.location.href = "spotify:track:" + dest.spotifyId;
      }, 200);
    }

    // 2) Always fallback to web URL
    setTimeout(function () {
      window.location.href = webUrl;
    }, 1300);
  }

  // Attach click handlers
  document.querySelectorAll('.cta').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      var destKey = this.getAttribute('data-dest');
      handleClick(destKey, e);
    });
  });

})();
</script>

</body>
</html>
